<app-navbar></app-navbar>

<div class="profil-container">
  <div class="header">
    <h1>Mon Profil</h1>
  </div>

  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }
  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }

  <div class="tabs">
    <button
      class="tab"
      [class.active]="activeTab() === 'profile'"
      (click)="activeTab.set('profile')"
    >
      Mes informations
    </button>
    @if (isProfessionnel()) {
      <button
        class="tab"
        [class.active]="activeTab() === 'rdv-pro'"
        (click)="activeTab.set('rdv-pro')"
      >
        Rendez-vous professionnels
      </button>
    }
  </div>

  <div class="tab-content">
    @if (activeTab() === 'profile' && user()) {
      <div class="profile-section">
        <div class="section-header">
          <h2>Informations personnelles</h2>
          @if (!isEditingProfile()) {
            <button class="btn-edit" (click)="isEditingProfile.set(true)">Modifier</button>
          } @else {
            <div class="btn-group">
              <button class="btn-cancel" (click)="isEditingProfile.set(false)">Annuler</button>
              <button class="btn-save" (click)="updateProfile()" [disabled]="isLoading()">
                Enregistrer
              </button>
            </div>
          }
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Pr√©nom</label>
            @if (isEditingProfile()) {
              <input type="text" [(ngModel)]="user()!.first_name" />
            } @else {
              <p class="info-text">{{ user()!.first_name || '-' }}</p>
            }
          </div>

          <div class="form-group">
            <label>Nom</label>
            @if (isEditingProfile()) {
              <input type="text" [(ngModel)]="user()!.last_name" />
            } @else {
              <p class="info-text">{{ user()!.last_name || '-' }}</p>
            }
          </div>

          <div class="form-group">
            <label>Email</label>
            <p class="info-text">{{ user()!.email }}</p>
          </div>

          <div class="form-group">
            <label>Nom d'utilisateur</label>
            <p class="info-text">{{ user()!.username }}</p>
          </div>

          <div class="form-group">
            <label>Date de naissance</label>
            @if (isEditingProfile()) {
              <input type="date" [(ngModel)]="user()!.date_naissance" />
            } @else {
              <p class="info-text">{{ user()!.date_naissance || '-' }}</p>
            }
          </div>

          <div class="form-group">
            <label>Sexe</label>
            @if (isEditingProfile()) {
              <select [(ngModel)]="user()!.sexe">
                <option value="">Non sp√©cifi√©</option>
                <option value="M">Masculin</option>
                <option value="F">F√©minin</option>
                <option value="A">Autre</option>
              </select>
            } @else {
              <p class="info-text">
                @if (user()!.sexe === 'M') {
                  Masculin
                } @else if (user()!.sexe === 'F') {
                  F√©minin
                } @else if (user()!.sexe === 'A') {
                  Autre
                } @else {
                  -
                }
              </p>
            }
          </div>

          <div class="form-group">
            <label>T√©l√©phone</label>
            @if (isEditingProfile()) {
              <input type="tel" [(ngModel)]="user()!.telephone" />
            } @else {
              <p class="info-text">{{ user()!.telephone || '-' }}</p>
            }
          </div>

          <div class="form-group">
            <label>T√©l√©phone d'urgence</label>
            @if (isEditingProfile()) {
              <input type="tel" [(ngModel)]="user()!.telephone_urgence" />
            } @else {
              <p class="info-text">{{ user()!.telephone_urgence || '-' }}</p>
            }
          </div>

          <div class="form-group full-width">
            <label>Adresse compl√®te</label>
            @if (isEditingProfile()) {
              <textarea [(ngModel)]="user()!.adresse_complete" rows="3"></textarea>
            } @else {
              <p class="info-text">{{ user()!.adresse_complete || '-' }}</p>
            }
          </div>

          <div class="form-group">
            <label>Ville</label>
            @if (isEditingProfile()) {
              <input type="text" [(ngModel)]="user()!.ville" />
            } @else {
              <p class="info-text">{{ user()!.ville || '-' }}</p>
            }
          </div>

          <div class="form-group">
            <label>Code postal</label>
            @if (isEditingProfile()) {
              <input type="text" [(ngModel)]="user()!.code_postal" />
            } @else {
              <p class="info-text">{{ user()!.code_postal || '-' }}</p>
            }
          </div>

          <div class="form-group">
            <label>Pays</label>
            @if (isEditingProfile()) {
              <input type="text" [(ngModel)]="user()!.pays" />
            } @else {
              <p class="info-text">{{ user()!.pays || '-' }}</p>
            }
          </div>

          <div class="form-group">
            <label>Num√©ro de s√©curit√© sociale</label>
            @if (isEditingProfile()) {
              <input type="text" [(ngModel)]="user()!.numero_securite_sociale" />
            } @else {
              <p class="info-text">{{ user()!.numero_securite_sociale || '-' }}</p>
            }
          </div>

          <div class="form-group">
            <label>Pr√©f√©rence de notification</label>
            @if (isEditingProfile()) {
              <select [(ngModel)]="user()!.preference_notification">
                <option value="email">Email</option>
                <option value="sms">SMS</option>
                <option value="les_deux">Email et SMS</option>
                <option value="aucune">Aucune</option>
              </select>
            } @else {
              <p class="info-text">
                @if (user()!.preference_notification === 'email') {
                  Email
                } @else if (user()!.preference_notification === 'sms') {
                  SMS
                } @else if (user()!.preference_notification === 'les_deux') {
                  Email et SMS
                } @else if (user()!.preference_notification === 'aucune') {
                  Aucune
                } @else {
                  -
                }
              </p>
            }
          </div>
        </div>
      </div>
    }

    @if (activeTab() === 'rdv-pro' && isProfessionnel()) {
      <div class="rdv-section">
        <h2>Mes rendez-vous en tant que professionnel</h2>

        @if (rendezVousProfessionnel().length === 0) {
          <div class="empty-state">
            <p>Aucun rendez-vous programm√©</p>
          </div>
        } @else {
          <div class="rdv-list">
            @for (rdv of rendezVousProfessionnel(); track rdv.id) {
              <div class="rdv-card">
                <div class="rdv-header">
                  <div>
                    <h3>Patient: {{ rdv.professionnel.prenom }} {{ rdv.professionnel.nom }}</h3>
                  </div>
                  <span class="badge" [ngClass]="getStatutBadgeClass(rdv.statut)">
                    {{ getStatutLabel(rdv.statut) }}
                  </span>
                </div>
                <div class="rdv-details">
                  <p><strong>Date:</strong> {{ formatDate(rdv.date) }}</p>
                  <p><strong>Heure:</strong> {{ rdv.heure_debut }} - {{ rdv.heure_fin }}</p>
                  <p>
                    <strong>Mode:</strong>
                    {{ rdv.mode === 'PRESENTIEL' ? 'En pr√©sentiel' : 'T√©l√©consultation' }}
                  </p>
                  @if (rdv.cabinet) {
                    <p><strong>Lieu:</strong> {{ rdv.cabinet.nom }}</p>
                  }
                  @if (rdv.notes_patient) {
                    <p><strong>Notes patient:</strong> {{ rdv.notes_patient }}</p>
                  }
                </div>
                <div class="rdv-actions">
                  @if (rdv.statut === 'EN_ATTENTE') {
                    <button
                      class="btn-action btn-confirm"
                      (click)="updateRendezVousStatut(rdv.id, 'CONFIRME')"
                    >
                      Confirmer
                    </button>
                    <button
                      class="btn-action btn-cancel-rdv"
                      (click)="updateRendezVousStatut(rdv.id, 'ANNULE')"
                    >
                      Annuler
                    </button>
                  }
                  @if (rdv.statut === 'CONFIRME') {
                    <button
                      class="btn-action btn-complete"
                      (click)="updateRendezVousStatut(rdv.id, 'TERMINE')"
                    >
                      Marquer termin√©
                    </button>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
      <div class="pro-settings">
        <h2>Param√®tres professionnels</h2>
        @if (professionnelProfile()) {
          <div class="form-grid">
            <div class="form-group">
              <label>Tarif consultation (‚Ç¨)</label>
              <input
                type="number"
                [(ngModel)]="professionnelProfile()!.tarif_consultation"
                min="0"
                step="0.5"
              />
            </div>
            <div class="form-group">
              <label>Accepte la t√©l√©consultation</label>
              <input
                type="checkbox"
                [(ngModel)]="professionnelProfile()!.accepte_teleconsultation"
              />
            </div>
          </div>
          <button class="btn-save" (click)="saveProfessionnelSettings()" [disabled]="isLoading()">
            Enregistrer
          </button>
        } @else {
          <p>Chargement du profil professionnel...</p>
        }
      </div>

      <div class="pro-dispos">
        <div class="section-header">
          <h2>Mes horaires d'ouverture</h2>
          @if (!showAddDispoForm()) {
            <button class="btn-add" (click)="showAddDispoForm.set(true)">
              + Ajouter une disponibilit√©
            </button>
          }
        </div>

        @if (disponibilites().length === 0) {
          <div class="empty-state">
            <p>
              Aucune disponibilit√© configur√©e. Ajoutez vos horaires d'ouverture pour que les
              patients puissent prendre rendez-vous.
            </p>
          </div>
        } @else {
          <div class="horaires-semaine">
            @for (jourIndex of [0, 1, 2, 3, 4, 5, 6]; track jourIndex) {
              <div class="jour-section" [class.has-dispos]="hasDisponibilitesForJour(jourIndex)">
                <div class="jour-header">
                  <h3>{{ joursLabels[jourIndex] }}</h3>
                </div>
                <div class="jour-dispos">
                  @if (getDisponibilitesByJour(jourIndex).length === 0) {
                    <p class="closed">Ferm√©</p>
                  } @else {
                    @for (d of getDisponibilitesByJour(jourIndex); track d.id) {
                      <div class="dispo-card">
                        @if (editingDispoId() === d.id) {
                          <!-- Mode √©dition -->
                          <div class="dispo-edit-form">
                            <div class="form-row">
                              <div class="form-group-small">
                                <label>Cabinet</label>
                                <select [(ngModel)]="editingDispo()!.cabinet_id">
                                  @for (cab of professionnelProfile()!.cabinets!; track cab.id) {
                                    <option [ngValue]="cab.id">{{ cab.nom }}</option>
                                  }
                                </select>
                              </div>
                              <div class="form-group-small">
                                <label>D√©but</label>
                                <input type="time" [(ngModel)]="editingDispo()!.heure_debut" />
                              </div>
                              <div class="form-group-small">
                                <label>Fin</label>
                                <input type="time" [(ngModel)]="editingDispo()!.heure_fin" />
                              </div>
                              <div class="form-group-small">
                                <label>Cr√©neau (min)</label>
                                <input
                                  type="number"
                                  [(ngModel)]="editingDispo()!.duree_creneau"
                                  min="5"
                                  step="5"
                                />
                              </div>
                            </div>
                            <div class="btn-group-inline">
                              <button
                                class="btn-save-small"
                                (click)="saveEditDisponibilite(d.id)"
                                [disabled]="isLoading()"
                              >
                                Enregistrer
                              </button>
                              <button class="btn-cancel-small" (click)="cancelEditDisponibilite()">
                                Annuler
                              </button>
                            </div>
                          </div>
                        } @else {
                          <div class="dispo-info">
                            <div class="dispo-time">
                              <span class="time-range"
                                >{{ d.heure_debut }} - {{ d.heure_fin }}</span
                              >
                              <span class="creneau-info"
                                >Cr√©neaux de {{ d.duree_creneau }} min</span
                              >
                            </div>
                            <div class="dispo-cabinet">
                              <span class="cabinet-label">üìç {{ d.cabinet.nom }}</span>
                            </div>
                          </div>
                          <div class="dispo-actions">
                            <button
                              class="btn-edit-small"
                              (click)="startEditDisponibilite(d)"
                              title="Modifier"
                            ></button>
                            <button
                              class="btn-delete-small"
                              (click)="deleteDisponibilite(d.id)"
                              title="Supprimer"
                            ></button>
                          </div>
                        }
                      </div>
                    }
                  }
                </div>
              </div>
            }
          </div>
        }

        @if (showAddDispoForm()) {
          <div class="add-dispo-form">
            <h3>Ajouter une nouvelle disponibilit√©</h3>
            @if (professionnelProfile()?.cabinets?.length) {
              <div class="form-grid">
                <div class="form-group">
                  <label>Cabinet *</label>
                  <select [(ngModel)]="newDispo().cabinet_id">
                    <option [ngValue]="null">Choisir un cabinet...</option>
                    @for (cab of professionnelProfile()!.cabinets!; track cab.id) {
                      <option [ngValue]="cab.id">{{ cab.nom }}</option>
                    }
                  </select>
                </div>
                <div class="form-group">
                  <label>Jour de la semaine *</label>
                  <select [(ngModel)]="newDispo().jour_semaine">
                    @for (day of [0, 1, 2, 3, 4, 5, 6]; track day) {
                      <option [ngValue]="day">{{ joursLabels[day] }}</option>
                    }
                  </select>
                </div>
                <div class="form-group">
                  <label>Heure de d√©but *</label>
                  <input type="time" [(ngModel)]="newDispo().heure_debut" step="300" />
                </div>
                <div class="form-group">
                  <label>Heure de fin *</label>
                  <input type="time" [(ngModel)]="newDispo().heure_fin" step="300" />
                </div>
                <div class="form-group">
                  <label>Dur√©e d'un cr√©neau (minutes) *</label>
                  <input
                    type="number"
                    [(ngModel)]="newDispo().duree_creneau"
                    min="5"
                    step="5"
                    placeholder="30"
                  />
                  <small>Dur√©e de chaque rendez-vous (ex: 15, 30, 45 min)</small>
                </div>
              </div>
              <div class="btn-group">
                <button
                  class="btn-save"
                  (click)="addDisponibilite()"
                  [disabled]="isLoading() || !newDispo().cabinet_id"
                >
                  Ajouter la disponibilit√©
                </button>
                <button class="btn-cancel" (click)="showAddDispoForm.set(false)">Annuler</button>
              </div>
            } @else {
              <p class="warning-message">
                Vous devez d'abord ajouter un cabinet √† votre profil dans la section ci-dessous.
              </p>
              <button class="btn-cancel" (click)="showAddDispoForm.set(false)">Fermer</button>
            }
          </div>
        }
      </div>

      <div class="pro-cabinets">
        <h2>Mes cabinets</h2>
        <div class="cabinet-list">
          @if (cabinets().length === 0) {
            <p>Aucun cabinet. Ajoutez-en un ci-dessous.</p>
          } @else {
            @for (cab of cabinets(); track cab.id) {
              <div class="cabinet-item">
                <div class="form-grid">
                  <div class="form-group">
                    <label>Nom</label>
                    <input type="text" [(ngModel)]="cab.nom" />
                  </div>
                  <div class="form-group full-width">
                    <label>Adresse</label>
                    <input type="text" [(ngModel)]="cab.adresse" />
                  </div>
                  <div class="form-group">
                    <label>Ville</label>
                    <input type="text" [(ngModel)]="cab.ville" />
                  </div>
                  <div class="form-group">
                    <label>Code postal</label>
                    <input type="text" [(ngModel)]="cab.code_postal" />
                  </div>
                  <div class="form-group">
                    <label>T√©l√©phone</label>
                    <input type="text" [(ngModel)]="cab.telephone" />
                  </div>
                </div>
                <div class="btn-group">
                  <button class="btn-save" (click)="updateCabinet(cab)" [disabled]="isLoading()">
                    Enregistrer
                  </button>
                  <button
                    class="btn-cancel"
                    (click)="deleteCabinet(cab.id)"
                    [disabled]="isLoading()"
                  >
                    Supprimer
                  </button>
                </div>
              </div>
            }
          }
        </div>

        <h3>Ajouter un cabinet</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Nom</label>
            <input type="text" [(ngModel)]="newCabinet().nom" />
          </div>
          <div class="form-group full-width">
            <label>Adresse</label>
            <input type="text" [(ngModel)]="newCabinet().adresse" />
          </div>
          <div class="form-group">
            <label>Ville</label>
            <input type="text" [(ngModel)]="newCabinet().ville" />
          </div>
          <div class="form-group">
            <label>Code postal</label>
            <input type="text" [(ngModel)]="newCabinet().code_postal" />
          </div>
          <div class="form-group">
            <label>T√©l√©phone</label>
            <input type="text" [(ngModel)]="newCabinet().telephone" />
          </div>
        </div>
        <button class="btn-save" (click)="addCabinet()" [disabled]="isLoading()">Ajouter</button>
      </div>
    }
  </div>
</div>
